<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Southwest Region (11cgd) - NOAA Tide Stations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 60px; }
        #controls { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            height: 60px; 
            background: white; 
            border-top: 1px solid #ccc; 
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 1000;
        }
        .stat { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; color: #666; }
        .stat-value { font-size: 18px; font-weight: 600; }
        .legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 13px;
        }
        .legend h4 { margin: 0 0 10px 0; font-size: 14px; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; }
        .legend-box { width: 30px; height: 3px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="legend">
        <h4>11cgd - Southwest</h4>
        <div style="color: #666; font-size: 11px; margin-bottom: 10px;">Southern CA, AZ, NV</div>
        <div class="legend-item"><div class="legend-box" style="background: #eab308; opacity: 0.5;"></div> Station Bounds</div>
        <div class="legend-item"><div class="legend-color" style="background: #3b82f6"></div> Tide Stations</div>
        <div style="margin-top: 10px; font-size: 11px; color: #666;">
            Click markers for station details
        </div>
    </div>
    <div id="controls">
        <div class="stat">
            <span class="stat-label">Tide Stations (CA)</span>
            <span class="stat-value" id="station-count">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">In 11cgd Bounds</span>
            <span class="stat-value" id="inside-count">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Outside Bounds</span>
            <span class="stat-value" id="outside-count">0</span>
        </div>
    </div>

    <script>
        // Initialize map centered on Southern California
        const map = L.map('map', {
            center: [34.5, -119.5],
            zoom: 7
        });

        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Southwest region (11cgd) station bounds
        const stationBounds = { west: -126, south: 30, east: -114, north: 38 };

        // Draw region boundary FIRST (so it's behind the markers)
        const bounds = [
            [stationBounds.south, stationBounds.west],
            [stationBounds.north, stationBounds.east]
        ];
        const boundaryRect = L.rectangle(bounds, {
            color: '#eab308',
            weight: 3,
            fillOpacity: 0.1,
            pane: 'overlayPane'  // Ensure it's below markers
        }).bindPopup('<b>11cgd Station Bounds</b><br>Southern CA, AZ, NV')
          .addTo(map);
        
        // Send boundary to back
        boundaryRect.bringToBack();

        // Function to check if station is within bounds
        function isInBounds(lat, lng) {
            return lat >= stationBounds.south && lat <= stationBounds.north &&
                   lng >= stationBounds.west && lng <= stationBounds.east;
        }

        // Load station data
        fetch('http://localhost:8765/tmp/ca_stations.json')
            .then(response => response.json())
            .then(stations => {
                let insideCount = 0;
                let outsideCount = 0;

                stations.forEach(station => {
                    const lat = parseFloat(station.lat);
                    const lng = parseFloat(station.lng);
                    const inBounds = isInBounds(lat, lng);

                    if (inBounds) insideCount++;
                    else outsideCount++;

                    // Create marker - larger and more visible, explicitly on top
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        fillColor: inBounds ? '#3b82f6' : '#94a3b8',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: inBounds ? 0.9 : 0.4,
                        pane: 'markerPane'  // Ensure markers are on top
                    });

                    // Add popup with station info
                    marker.bindPopup(`
                        <b>${station.name}</b><br>
                        ID: ${station.id}<br>
                        Lat: ${lat.toFixed(4)}°<br>
                        Lng: ${lng.toFixed(4)}°<br>
                        Type: ${station.type === 'R' ? 'Reference' : 'Subordinate'}<br>
                        <span style="color: ${inBounds ? '#22c55e' : '#ef4444'}">
                            ${inBounds ? '✓ In 11cgd bounds' : '✗ Outside bounds'}
                        </span>
                    `);

                    marker.addTo(map);
                });

                // Update statistics
                document.getElementById('station-count').textContent = stations.length;
                document.getElementById('inside-count').textContent = insideCount;
                document.getElementById('outside-count').textContent = outsideCount;

                console.log(`Loaded ${stations.length} stations (${insideCount} in bounds, ${outsideCount} outside)`);
            })
            .catch(error => {
                console.error('Error loading stations:', error);
            });
    </script>
</body>
</html>
