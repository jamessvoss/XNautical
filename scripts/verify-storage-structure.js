#!/usr/bin/env node
/**
 * Verify Firebase Storage Structure
 * 
 * Checks that all expected files exist in Firebase Storage for each district.
 * Based on what the district-metadata generator expects.
 * 
 * Expected structure per district:
 * {districtId}/
 *   â”œâ”€â”€ charts/
 *   â”‚   â”œâ”€â”€ US1.mbtiles.zip
 *   â”‚   â”œâ”€â”€ US2.mbtiles.zip
 *   â”‚   â”œâ”€â”€ US3.mbtiles.zip
 *   â”‚   â”œâ”€â”€ US4.mbtiles.zip  (required)
 *   â”‚   â”œâ”€â”€ US5.mbtiles.zip  (required)
 *   â”‚   â””â”€â”€ US6.mbtiles.zip
 *   â”œâ”€â”€ gnis/
 *   â”‚   â””â”€â”€ gnis_names.mbtiles.zip  (required)
 *   â”œâ”€â”€ basemaps/
 *   â”‚   â””â”€â”€ basemap.mbtiles.zip
 *   â”œâ”€â”€ ocean/
 *   â”‚   â””â”€â”€ ocean.mbtiles.zip
 *   â”œâ”€â”€ terrain/
 *   â”‚   â””â”€â”€ terrain.mbtiles.zip
 *   â”œâ”€â”€ satellite/
 *   â”‚   â”œâ”€â”€ satellite.mbtiles.zip  (single file OR...)
 *   â”‚   â”œâ”€â”€ satellite_z0-5.mbtiles.zip  (zoom-level files)
 *   â”‚   â”œâ”€â”€ satellite_z6-7.mbtiles.zip
 *   â”‚   â”œâ”€â”€ satellite_z8.mbtiles.zip
 *   â”‚   â”œâ”€â”€ satellite_z9.mbtiles.zip
 *   â”‚   â”œâ”€â”€ satellite_z10.mbtiles.zip
 *   â”‚   â”œâ”€â”€ satellite_z11.mbtiles.zip
 *   â”‚   â”œâ”€â”€ satellite_z12.mbtiles.zip
 *   â”‚   â”œâ”€â”€ satellite_z13.mbtiles.zip
 *   â”‚   â””â”€â”€ satellite_z14.mbtiles.zip
 *   â”œâ”€â”€ predictions/
 *   â”‚   â”œâ”€â”€ tides_{districtId}.db.zip
 *   â”‚   â””â”€â”€ currents_{districtId}.db.zip
 *   â””â”€â”€ download-metadata.json  (generated by metadata service)
 */

const admin = require('firebase-admin');
const path = require('path');

// Initialize Firebase Admin
const serviceAccountPath = process.env.GOOGLE_APPLICATION_CREDENTIALS
  || path.resolve(__dirname, '..', 'xnautical-service-account.json');

try {
  const serviceAccount = require(serviceAccountPath);
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    storageBucket: 'xnautical-8a296.firebasestorage.app',
    projectId: 'xnautical-8a296',
  });
} catch (error) {
  console.error('Error loading service account:', error.message);
  console.error('\nMake sure you have the service account key at:');
  console.error('  xnautical-service-account.json');
  process.exit(1);
}

const bucket = admin.storage().bucket();
const db = admin.firestore();

// District IDs to check
const DISTRICT_IDS = [
  '01cgd', // 1st District - Northeast (Boston)
  '05cgd', // 5th District - Mid-Atlantic (Portsmouth)
  '07cgd', // 7th District - Southeast (Miami)
  '08cgd', // 8th District - Gulf Coast (New Orleans)
  '09cgd', // 9th District - Great Lakes (Cleveland)
  '11cgd', // 11th District - Pacific (Alameda)
  '13cgd', // 13th District - Pacific Northwest (Seattle)
  '14cgd', // 14th District - Pacific Islands (Honolulu)
  '17cgd', // 17th District - Alaska (Juneau)
];

const CHART_SCALES = ['US1', 'US2', 'US3', 'US4', 'US5', 'US6'];
const REQUIRED_SCALES = ['US4', 'US5'];

const SATELLITE_ZOOM_LEVELS = [
  'z0-5', 'z6-7', 'z8', 'z9', 'z10', 'z11', 'z12', 'z13', 'z14'
];

async function fileExists(filePath) {
  try {
    const file = bucket.file(filePath);
    const [exists] = await file.exists();
    if (exists) {
      const [metadata] = await file.getMetadata();
      return {
        exists: true,
        size: parseInt(metadata.size),
        sizeMB: (parseInt(metadata.size) / 1024 / 1024).toFixed(2)
      };
    }
    return { exists: false };
  } catch (error) {
    return { exists: false, error: error.message };
  }
}

async function checkDistrict(districtId) {
  console.log(`\n${'='.repeat(80)}`);
  console.log(`Checking District: ${districtId}`);
  console.log('='.repeat(80));

  const results = {
    districtId,
    charts: {},
    gnis: null,
    basemap: null,
    ocean: null,
    terrain: null,
    satellite: { single: null, zoomLevels: {} },
    predictions: {},
    metadata: null,
    issues: [],
    warnings: []
  };

  // Check charts
  console.log('\nðŸ“Š CHARTS:');
  for (const scale of CHART_SCALES) {
    const filePath = `${districtId}/charts/${scale}.mbtiles.zip`;
    const result = await fileExists(filePath);
    results.charts[scale] = result;
    
    const isRequired = REQUIRED_SCALES.includes(scale);
    const status = result.exists ? 'âœ…' : (isRequired ? 'âŒ' : 'âš ï¸');
    console.log(`  ${status} ${scale}: ${result.exists ? `${result.sizeMB} MB` : 'MISSING'}`);
    
    if (!result.exists && isRequired) {
      results.issues.push(`Missing required chart scale: ${scale}`);
    } else if (!result.exists) {
      results.warnings.push(`Missing optional chart scale: ${scale}`);
    }
  }

  // Check GNIS
  console.log('\nðŸ—ºï¸  GNIS (Place Names):');
  const gnisPath = `${districtId}/gnis/gnis_names.mbtiles.zip`;
  results.gnis = await fileExists(gnisPath);
  console.log(`  ${results.gnis.exists ? 'âœ…' : 'âŒ'} GNIS: ${results.gnis.exists ? `${results.gnis.sizeMB} MB` : 'MISSING'}`);
  if (!results.gnis.exists) {
    results.issues.push('Missing required GNIS place names');
  }

  // Check basemap
  console.log('\nðŸ—ºï¸  BASEMAP:');
  const basemapPath = `${districtId}/basemaps/basemap.mbtiles.zip`;
  results.basemap = await fileExists(basemapPath);
  console.log(`  ${results.basemap.exists ? 'âœ…' : 'âš ï¸'} Basemap: ${results.basemap.exists ? `${results.basemap.sizeMB} MB` : 'MISSING'}`);
  if (!results.basemap.exists) {
    results.warnings.push('Missing optional basemap');
  }

  // Check ocean
  console.log('\nðŸŒŠ OCEAN MAP:');
  const oceanPath = `${districtId}/ocean/ocean.mbtiles.zip`;
  results.ocean = await fileExists(oceanPath);
  console.log(`  ${results.ocean.exists ? 'âœ…' : 'âš ï¸'} Ocean: ${results.ocean.exists ? `${results.ocean.sizeMB} MB` : 'MISSING'}`);
  if (!results.ocean.exists) {
    results.warnings.push('Missing optional ocean map');
  }

  // Check terrain
  console.log('\nâ›°ï¸  TERRAIN MAP:');
  const terrainPath = `${districtId}/terrain/terrain.mbtiles.zip`;
  results.terrain = await fileExists(terrainPath);
  console.log(`  ${results.terrain.exists ? 'âœ…' : 'âš ï¸'} Terrain: ${results.terrain.exists ? `${results.terrain.sizeMB} MB` : 'MISSING'}`);
  if (!results.terrain.exists) {
    results.warnings.push('Missing optional terrain map');
  }

  // Check satellite
  console.log('\nðŸ›°ï¸  SATELLITE IMAGERY:');
  
  // Check single file
  const satSinglePath = `${districtId}/satellite/satellite.mbtiles.zip`;
  results.satellite.single = await fileExists(satSinglePath);
  
  if (results.satellite.single.exists) {
    console.log(`  âœ… Single satellite file: ${results.satellite.single.sizeMB} MB`);
  } else {
    console.log('  Single file: Not found, checking zoom-level files...');
    
    // Check zoom-level files
    let foundAny = false;
    for (const zoom of SATELLITE_ZOOM_LEVELS) {
      const satZoomPath = `${districtId}/satellite/satellite_${zoom}.mbtiles.zip`;
      const zoomResult = await fileExists(satZoomPath);
      results.satellite.zoomLevels[zoom] = zoomResult;
      
      if (zoomResult.exists) {
        console.log(`  âœ… ${zoom}: ${zoomResult.sizeMB} MB`);
        foundAny = true;
      }
    }
    
    if (!foundAny) {
      console.log('  âš ï¸  No satellite imagery found (neither single nor zoom-level files)');
      results.warnings.push('Missing optional satellite imagery');
    }
  }

  // Check predictions
  console.log('\nðŸŒŠ PREDICTIONS:');
  const tidesPath = `${districtId}/predictions/tides_${districtId}.db.zip`;
  const currentsPath = `${districtId}/predictions/currents_${districtId}.db.zip`;
  
  results.predictions.tides = await fileExists(tidesPath);
  results.predictions.currents = await fileExists(currentsPath);
  
  console.log(`  ${results.predictions.tides.exists ? 'âœ…' : 'âŒ'} Tides: ${results.predictions.tides.exists ? `${results.predictions.tides.sizeMB} MB` : 'MISSING'}`);
  console.log(`  ${results.predictions.currents.exists ? 'âœ…' : 'âŒ'} Currents: ${results.predictions.currents.exists ? `${results.predictions.currents.sizeMB} MB` : 'MISSING'}`);
  
  if (!results.predictions.tides.exists) {
    results.issues.push('Missing tide predictions database');
  }
  if (!results.predictions.currents.exists) {
    results.issues.push('Missing current predictions database');
  }

  // Check download metadata
  console.log('\nðŸ“‹ METADATA:');
  const metadataPath = `${districtId}/download-metadata.json`;
  results.metadata = await fileExists(metadataPath);
  console.log(`  ${results.metadata.exists ? 'âœ…' : 'âš ï¸'} download-metadata.json: ${results.metadata.exists ? 'EXISTS' : 'MISSING - needs generation'}`);
  if (!results.metadata.exists) {
    results.warnings.push('Missing download-metadata.json - run generate-download-metadata.js');
  }

  // Summary
  console.log('\n' + 'â”€'.repeat(80));
  console.log('SUMMARY:');
  console.log(`  Issues: ${results.issues.length}`);
  console.log(`  Warnings: ${results.warnings.length}`);
  
  if (results.issues.length > 0) {
    console.log('\nâŒ ISSUES (Required files missing):');
    results.issues.forEach(issue => console.log(`  - ${issue}`));
  }
  
  if (results.warnings.length > 0) {
    console.log('\nâš ï¸  WARNINGS (Optional files missing):');
    results.warnings.forEach(warning => console.log(`  - ${warning}`));
  }
  
  if (results.issues.length === 0 && results.warnings.length === 0) {
    console.log('  âœ… All files present!');
  }

  return results;
}

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                  FIREBASE STORAGE STRUCTURE VERIFICATION                   â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

  const allResults = [];

  for (const districtId of DISTRICT_IDS) {
    const result = await checkDistrict(districtId);
    allResults.push(result);
  }

  // Overall summary
  console.log('\n\n');
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                            OVERALL SUMMARY                                 â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  const totalIssues = allResults.reduce((sum, r) => sum + r.issues.length, 0);
  const totalWarnings = allResults.reduce((sum, r) => sum + r.warnings.length, 0);

  console.log(`Districts checked: ${DISTRICT_IDS.length}`);
  console.log(`Total issues: ${totalIssues}`);
  console.log(`Total warnings: ${totalWarnings}`);

  console.log('\nðŸ“Š District Status:');
  allResults.forEach(result => {
    const status = result.issues.length === 0 ? 'âœ…' : 'âŒ';
    const warnIcon = result.warnings.length > 0 ? 'âš ï¸' : '';
    console.log(`  ${status} ${warnIcon} ${result.districtId}: ${result.issues.length} issues, ${result.warnings.length} warnings`);
  });

  if (totalIssues === 0 && totalWarnings === 0) {
    console.log('\nðŸŽ‰ All districts have complete data!');
  } else if (totalIssues === 0) {
    console.log('\nâœ… All required files present. Some optional files missing.');
  } else {
    console.log('\nâŒ Some required files are missing. Review issues above.');
  }

  process.exit(totalIssues > 0 ? 1 : 0);
}

main().catch(error => {
  console.error('Error:', error);
  process.exit(1);
});
